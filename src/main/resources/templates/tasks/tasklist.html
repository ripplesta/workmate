<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>タスク管理</title>
</head>
<body>
    <h1>タスク一覧</h1>
    <form th:action="@{/tasks/search}" method="get">
        <div>
            タイトル：<input type="text" name="title" th:value="${title}" placeholder="キーワードを入力">
            期限日：<input type="text" name="dueDate" th:value="${dueDate}" placeholder="yyyy-MM-dd or yyyy-MM">
        </div>
        <div>
            期限範囲指定：
            <button type="button" onclick="setRenge('today')">今日まで</button>
            <button type="button" onclick="setRenge('week')">1週間以内</button>
            <button type="button" onclick="setRenge('month')">今月</button>
            開始日:<input type="date" name="startDate" th:value="${startDate}">
            終了日:<input type="date" name="endDate" th:value="${endDate}">
        </div>

        <script>
            function formatLocalDate(date) {
                let y = date.getFullYear();
                let m = String(date.getMonth() + 1).padStart(2, '0');
                let d = String(date.getDate()).padStart(2, '0');
                return '${y}-${m}-${d}';
            }
            function setRenge(type){
                const start = document.querySelector('input[name="startDate"]');
                const end = document.querySelector('input[name="endDate"]');
                const today = new Date();

                if(type === 'today') {
                    start.value = today.toISOString().split('T')[0];
                    end.value = today.toISOString().split('T')[0];
                } 
                else if(type === 'week') {
                    start.value = today.toISOString().split('T')[0];
                    let weekLater = new Date(today);
                    weekLater.setDate(today.getDate() + 7);
                    end.value = formatLocalDate(weekLater);
                }
                else if(type === 'month') {
                    start.value = today.toISOString().split('T')[0];
                    let endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    end.value = formatLocalDate(endOfMonth);
                }
            }
        </script>
        <div>
            進捗状況：
            <select name="status">
                <option value="">--選択--</option>
                <option value="未着手" th:selected="${status=='未着手'}">未着手</option>
                <option value="進行中" th:selected="${status=='進行中'}">進行中</option>
                <option value="完了" th:selected="${status=='完了'}">完了</option>
            </select>
            優先度：
            <select name="priority">
                <option value="">--選択--</option>
                <option value="高" th:selected="${priority=='高'}">高</option>
                <option value="中" th:selected="${priority=='中'}">中</option>
                <option value="低" th:selected="${priority=='低'}">低</option>
            </select>
            カテゴリ：
            <select name="category">
                <option value="">--選択--</option>
                <option value="仕事" th:selected="${category=='仕事'}">仕事</option>
                <option value="趣味" th:selected="${category=='趣味'}">趣味</option>
                <option value="勉強" th:selected="${category=='勉強'}">勉強</option>
                <option value="生活" th:selected="${category=='生活'}">生活</option>
                <option value="その他" th:selected="${category=='その他'}">その他</option>
            </select>
        </div>
        <div>
            ソート：
            <select name="sortBy">
                <option value="dueDate" th:selected="${sortBy=='dueDate'}">期限日</option>
                <option value="createdAt" th:selected="${sortBy=='createdAt'}">作成日</option>
            </select>
            <select name="order">
                <option value="asc" th:selected="${order=='asc'}">昇順</option>
                <option value="desc" th:selected="${order=='desc'}">降順</option>
            </select>
            <button type="submit" >検索</button>
            <a th:href="@{/tasks/refresh}">元に戻す</a>
        </div>
    </form>
    
    <!--
    <label>ソート:</label>
    <a th:href="@{/tasks/tasklist/sort(sortBy='dueDate')}">期限日順</a> |
    <a th:href="@{/tasks/tasklist/sort(sortBy='createdAt')}">作成日順</a>
    -->
    <table border="1">
        <thead>
            <tr>
                <th>タイトル</th>
                <th>内容</th>
                <th>締め切り</th>
                <th>進捗状況</th>
                <th>優先度</th>
                <th>カテゴリ</th>
                <th>作成日</th>
                <th>更新日</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="task : ${tasks}">
                <td th:text="${task.title}"></td>
                <td th:text="${task.description}"></td>
                <td th:text="${#temporals.format(task.dueDate, 'yyyy-MM-dd')}"></td>
                <td th:text="${task.status}"></td>
                <td th:text="${task.priority}"></td>
                <td th:text="${task.category}"></td>
                <td th:text="${#temporals.format(task.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                <td th:text="${#temporals.format(task.updatedAt, 'yyyy-MM-dd HH:mm')}"></td>
        
                <td> 
                    <form th:action="@{'/tasks/edit/' + ${task.id}}" method="get" style="display:inline">
                        <input type="submit" value="編集" >
                    </form>
                    <form th:action="@{'/tasks/delete/' + ${task.id}}" method="post" style="display:inline">
                        <input type="submit" value="削除" onclick="return confirm('本当に削除しますか？');">
                    </form>
                </td>
            </tr>
        </tbody>
    </table>
    <a th:href="@{/tasks/new}">タスクを登録</a>
    <a th:href="@{/dashboard}">メニューに戻る</a>
</body>
</html>